# Architecture Evolution

このドキュメントでは MathOvercome がどのようにアーキテクチャ面で成長し、
クラウドに向けてスケールしていったのかを時系列でまとめます。


---

## Phase 1: ローカル環境（2025/5）
- ローカル環境でアプリケーションの基本構成を確立
- アプリMathOvercome完成
- Spring Boot をローカルで起動
- MySQL をローカルで起動
- Next.js をローカルで起動

---

## Phase 2: Docker Compose 化（2025/11）
- 3コンテナ構成へ移行（frontend / backend / db）
- init.sql の導入でclone時の再現性向上

---

## Phase 3: **EC2 単体デプロイ**（2025/12）
- **デフォルト VPC** の **パブリックサブネット** に **EC2** を構築し、Docker Compose で frontend / backend / db を起動
- SG にて **ポート3000（Next.js）** を **0.0.0.0/0** で公開
- SSH は当初、**自宅 PC のグローバル IP のみに制限**していたが、**IP 変動**のため一時的に **0.0.0.0/0** に変更
- 再起動のたびにパブリック IP が変わるため、**Elastic IP** の利用を検討
- **1 インスタンスで 3 コンテナを稼働**させたところ **メモリ不足でダウン**
- データベースを RDS などのマネージドサービスへ切り離す方針を検討

---

## Phase 4: RDS 分離・ネットワーク整理（2025/12）

- データベースを EC2 内コンテナから **RDSへ分離**
- RDS の SG にて **ポート 3306 を EC2 の SG のみ許可**
- 新規 VPC を作成し、**RDS をプライベートサブネットに配置する構成を検討**

### ネットワーク / 通信構成
- クライアントコンポーネント構成のため、**EC2 の SG で Backend ポート 8080 を開放**
- **Next.js クライアントから Backend API を直接呼び出す構成**を採用
- 今後、**Next.js Server Component または Route Handler 経由で fetch する構成への移行を検討**

### セキュリティ / 設定管理
- RDS の接続情報は GitHub に公開せず、  
  **EC2 インスタンス上の `.env` から環境変数として設定**
- CORS 設定や環境変数で **グローバル IP を使用する箇所が増えたため Elastic IP を使用**
- HTTPS 未対応環境において secure cookie によりセッションが維持されない問題が発生したため、  
  **HTTP 環境向けにセッション Cookie 設定を変更**

  ---

  ## Phase 5: 静的コンテンツの S3 + CloudFront 移行とセキュリティ強化（2026/2）

Frontend を EC2 コンテナから分離し、コスト削減、セキュリティ向上、および配信の高速化を実現。

### Frontend のビルド設定と最適化
- `next.config.ts` で `output: 'export'` を設定し、Next.js をサーバーがなくても動く静的なファイルとしてビルド。
- URLのパラメータを取得する箇所でエラーが出たため、`Suspense` を使ってブラウザ側で読み込むようにコードを調整。機能はそのままで静的ファイルをビルド。
- S3のフォルダ構成とブラウザからのリクエストURLが一致していなかったため、`trailingSlash: true` を追加。S3 内の構成を「フォルダ / index.html」という形に統一し、ブラウザのリクエストとファイルの置き場所を合わせた。

### S3 の構築と段階的な公開設定
- 最初は S3 単体で動くか確認するため、一時的に S3 の **静的ウェブサイトホスティング** を有効化。パブリックアクセスを許可し、バケットポリシーで `GetObject` を全公開する構成でデプロイ。
- CloudFront 導入後、パブリックアクセスおよび静的ウェブサイトホスティングを無効化。

### CloudFront による配信とセキュリティ強化
- CloudFront に **OAC** を設定。バケットポリシーを更新し、特定の CloudFront からのアクセスのみを許可する構成へ移行。
- S3のフォルダ構成とブラウザからのリクエストURLが一致せず、リロード時にエラー（Access Denied）が発生。**CloudFront Functions** を作成し、リクエスト時にパスの自動書き換えを行うことで解決。
- これにより **HTTPS 化**、**バケットの非公開**、**エッジからの高速配信** を実現。

---

